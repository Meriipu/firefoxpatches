From fded066b2c06e1c42e013e3e77ba715776817eaf Mon Sep 17 00:00:00 2001
From: Meriipu <Meriipu@users.noreply.github.com>
Date: Sat, 22 May 2021 15:35:02 +0200
Subject: [PATCH 03/10] revert the removal of the dropmarker et al.

as of 78 this alone is not enough to have the dropmarker be functional
some additional patches to fix autoOpen on focus/select as well as
avoiding one of the providers is necessary. This commit alone only adds
the dropmarker back cosmetically.
---
 browser/base/content/browser.css              |  1 +
 browser/base/content/browser.xhtml            |  3 +++
 browser/components/urlbar/UrlbarInput.jsm     | 19 +++++++++++++++
 browser/components/urlbar/UrlbarView.jsm      |  3 +++
 .../themes/shared/urlbar-searchbar.inc.css    | 24 +++++++++++++++++++
 5 files changed, 50 insertions(+)

diff --git a/browser/base/content/browser.css b/browser/base/content/browser.css
index e6879a99a7e3..8130cd669b59 100644
--- a/browser/base/content/browser.css
+++ b/browser/base/content/browser.css
@@ -722,6 +722,7 @@ toolbar:not(#TabsToolbar) > #personal-bookmarks {
 #urlbar-input-container[pageproxystate=invalid] > #page-action-buttons > .urlbar-page-action,
 #identity-box.chromeUI ~ #page-action-buttons > .urlbar-page-action:not(#star-button-box),
 #urlbar[usertyping] > #urlbar-input-container > #page-action-buttons > #urlbar-zoom-button,
+#urlbar[usertyping] > #urlbar-input-container > .urlbar-history-dropmarker,
 #urlbar:not([usertyping]) > #urlbar-input-container > #urlbar-go-button,
 #urlbar:not([focused]) > #urlbar-input-container > #urlbar-go-button {
   display: none;
diff --git a/browser/base/content/browser.xhtml b/browser/base/content/browser.xhtml
index 57a95856fa4b..f4cc7df0485c 100644
--- a/browser/base/content/browser.xhtml
+++ b/browser/base/content/browser.xhtml
@@ -1993,6 +1993,9 @@
                      class="urlbar-icon"
                      onclick="gURLBar.handleCommand(event);"
                      data-l10n-id="urlbar-go-button"/>
+              <image class="urlbar-history-dropmarker urlbar-icon chromeclass-toolbar-additional"
+                     hidden="false"
+                     tooltiptext="Show history"/>
               <hbox id="page-action-buttons" context="pageActionContextMenu">
                 <toolbartabstop/>
                 <hbox id="contextual-feature-recommendation" role="button" hidden="true">
diff --git a/browser/components/urlbar/UrlbarInput.jsm b/browser/components/urlbar/UrlbarInput.jsm
index 516fd60afcd0..395edee91f59 100644
--- a/browser/components/urlbar/UrlbarInput.jsm
+++ b/browser/components/urlbar/UrlbarInput.jsm
@@ -183,6 +183,8 @@ class UrlbarInput {
     }
 
     this.inputField = this.querySelector("#urlbar-input");
+    this.dropmarker = this.querySelector(".urlbar-history-dropmarker");
+    this.dropmarker.hidden = false;
     this._inputContainer = this.querySelector("#urlbar-input-container");
     this._identityBox = this.querySelector("#identity-box");
     this._searchModeIndicator = this.querySelector(
@@ -237,6 +239,7 @@ class UrlbarInput {
       this.addEventListener(name, this);
     }
 
+    this.dropmarker.addEventListener("mousedown", this);
     this.window.addEventListener("mousedown", this);
     if (AppConstants.platform == "win") {
       this.window.addEventListener("draggableregionleftmousedown", this);
@@ -2921,6 +2924,22 @@ class UrlbarInput {
           });
         }
         break;
+      case this.dropmarker:
+        if (event.button != 0) {
+          break;
+        }
+
+        if (this.view.isOpen) {
+          this.view.close();
+        } else {
+          this.focus();
+          this.startQuery({
+            allowAutofill: false,
+            event,
+          });
+          this._maybeSelectAll();
+        }
+        break;
       case this.window:
         if (this._mousedownOnUrlbarDescendant) {
           this._mousedownOnUrlbarDescendant = false;
diff --git a/browser/components/urlbar/UrlbarView.jsm b/browser/components/urlbar/UrlbarView.jsm
index ed2e7b09fd21..efdee0d31376 100644
--- a/browser/components/urlbar/UrlbarView.jsm
+++ b/browser/components/urlbar/UrlbarView.jsm
@@ -460,6 +460,8 @@ class UrlbarView {
     this._openPanelInstance = null;
     this._previousTabToSearchEngine = null;
 
+    this.input.dropmarker.removeAttribute("open");
+
     this.input.removeAttribute("open");
     this.input.endLayoutExtend();
 
@@ -869,6 +871,7 @@ class UrlbarView {
     this._enableOrDisableRowWrap();
 
     this.input.inputField.setAttribute("aria-expanded", "true");
+    this.input.dropmarker.setAttribute("open", "true");
 
     this.input.toggleAttribute("suppress-focus-border", true);
     this.input.setAttribute("open", "true");
diff --git a/browser/themes/shared/urlbar-searchbar.inc.css b/browser/themes/shared/urlbar-searchbar.inc.css
index e9fde8b8d0db..af34a1d5e78d 100644
--- a/browser/themes/shared/urlbar-searchbar.inc.css
+++ b/browser/themes/shared/urlbar-searchbar.inc.css
@@ -679,6 +679,19 @@
   transform: scaleX(-1);
 }
 
+.urlbar-history-dropmarker {
+  list-style-image: url(chrome://global/skin/icons/arrow-dropdown-16.svg);
+  transition: opacity 0.15s ease;
+}
+
+#urlbar[switchingtabs] > #urlbar-input-container > .urlbar-history-dropmarker {
+  transition: none;
+}
+
+#nav-bar:not([customizing="true"]) > #nav-bar-customization-target > #urlbar-container:not(:hover) > #urlbar:not([focused]) > #urlbar-input-container > .urlbar-history-dropmarker {
+  opacity: 0;
+}
+
 #pageActionButton,
 .share-more-button {
   list-style-image: url("chrome://global/skin/icons/more.svg");
@@ -869,6 +882,17 @@
   mask-position-x: 0;
 }
 
+/* Translate the dropmarker to give illusion of increasing width of the recommendation  */
+#urlbar[cfr-recommendation-state] .urlbar-history-dropmarker {
+  transition: transform ease-in-out var(--cfr-animation-duration);
+}
+#urlbar[cfr-recommendation-state="expanded"] .urlbar-history-dropmarker {
+  transform: translateX(calc(var(--cfr-label-width) * -1));
+}
+#urlbar[cfr-recommendation-state="expanded"] .urlbar-history-dropmarker:-moz-locale-dir(rtl) {
+  transform: translateX(calc(var(--cfr-label-width)));
+}
+
 /* Shift the url-bar text fading to stop the recommendation overlapping */
 #urlbar[cfr-recommendation-state] #urlbar-input {
   /* A mask-image is usually only defined for the url bar when text overflows.
-- 
2.31.1

