From 6381c9e2e921f66bab46ce7bb62146cf0e2786f6 Mon Sep 17 00:00:00 2001
From: Meriipu <Meriipu@users.noreply.github.com>
Date: Fri, 17 Dec 2021 15:55:13 +0100
Subject: [PATCH 03/10] revert the removal of the dropmarker et al.

as of 78 this alone is not enough to have the dropmarker be functional
some additional patches to fix autoOpen on focus/select as well as
avoiding one of the providers is necessary. This commit alone only adds
the dropmarker back cosmetically.
---
 browser/base/content/browser.css              |  1 +
 .../base/content/navigator-toolbox.inc.xhtml  |  3 +++
 browser/components/urlbar/UrlbarInput.jsm     | 19 +++++++++++++++
 browser/components/urlbar/UrlbarView.jsm      |  3 +++
 browser/themes/shared/urlbar-searchbar.css    | 24 +++++++++++++++++++
 5 files changed, 50 insertions(+)

diff --git a/browser/base/content/browser.css b/browser/base/content/browser.css
index 03a778809dc8..24013f36b4e7 100644
--- a/browser/base/content/browser.css
+++ b/browser/base/content/browser.css
@@ -706,6 +706,7 @@ toolbar:not(#TabsToolbar) > #personal-bookmarks {
 #urlbar-input-container[pageproxystate=invalid] > #page-action-buttons > .urlbar-page-action,
 #identity-box.chromeUI ~ #page-action-buttons > .urlbar-page-action:not(#star-button-box),
 #urlbar[usertyping] > #urlbar-input-container > #page-action-buttons > #urlbar-zoom-button,
+#urlbar[usertyping] > #urlbar-input-container > .urlbar-history-dropmarker,
 #urlbar:not([usertyping]) > #urlbar-input-container > #urlbar-go-button,
 #urlbar:not([focused]) > #urlbar-input-container > #urlbar-go-button {
   display: none;
diff --git a/browser/base/content/navigator-toolbox.inc.xhtml b/browser/base/content/navigator-toolbox.inc.xhtml
index 316d3ef98371..77f7d2e3daba 100644
--- a/browser/base/content/navigator-toolbox.inc.xhtml
+++ b/browser/base/content/navigator-toolbox.inc.xhtml
@@ -321,6 +321,9 @@
                    class="urlbar-icon"
                    onclick="gURLBar.handleCommand(event);"
                    data-l10n-id="urlbar-go-button"/>
+            <image class="urlbar-history-dropmarker urlbar-icon chromeclass-toolbar-additional"
+                   hidden="false"
+                   tooltiptext="Show history"/>
             <hbox id="page-action-buttons" context="pageActionContextMenu">
               <toolbartabstop/>
               <hbox id="contextual-feature-recommendation" role="button" hidden="true">
diff --git a/browser/components/urlbar/UrlbarInput.jsm b/browser/components/urlbar/UrlbarInput.jsm
index c57889efac6e..ea07ffad2043 100644
--- a/browser/components/urlbar/UrlbarInput.jsm
+++ b/browser/components/urlbar/UrlbarInput.jsm
@@ -182,6 +182,8 @@ class UrlbarInput {
     }
 
     this.inputField = this.querySelector("#urlbar-input");
+    this.dropmarker = this.querySelector(".urlbar-history-dropmarker");
+    this.dropmarker.hidden = false;
     this._inputContainer = this.querySelector("#urlbar-input-container");
     this._identityBox = this.querySelector("#identity-box");
     this._searchModeIndicator = this.querySelector(
@@ -241,6 +243,7 @@ class UrlbarInput {
       this.addEventListener(name, this);
     }
 
+    this.dropmarker.addEventListener("mousedown", this);
     this.window.addEventListener("mousedown", this);
     if (AppConstants.platform == "win") {
       this.window.addEventListener("draggableregionleftmousedown", this);
@@ -3046,6 +3049,22 @@ class UrlbarInput {
           });
         }
         break;
+      case this.dropmarker:
+        if (event.button != 0) {
+          break;
+        }
+
+        if (this.view.isOpen) {
+          this.view.close();
+        } else {
+          this.focus();
+          this.startQuery({
+            allowAutofill: false,
+            event,
+          });
+          this._maybeSelectAll();
+        }
+        break;
       case this.window:
         if (this._mousedownOnUrlbarDescendant) {
           this._mousedownOnUrlbarDescendant = false;
diff --git a/browser/components/urlbar/UrlbarView.jsm b/browser/components/urlbar/UrlbarView.jsm
index 6d26bb276681..e55937ce372e 100644
--- a/browser/components/urlbar/UrlbarView.jsm
+++ b/browser/components/urlbar/UrlbarView.jsm
@@ -463,6 +463,8 @@ class UrlbarView {
     this._openPanelInstance = null;
     this._previousTabToSearchEngine = null;
 
+    this.input.dropmarker.removeAttribute("open");
+
     this.input.removeAttribute("open");
     this.input.endLayoutExtend();
 
@@ -890,6 +892,7 @@ class UrlbarView {
     this._enableOrDisableRowWrap();
 
     this.input.inputField.setAttribute("aria-expanded", "true");
+    this.input.dropmarker.setAttribute("open", "true");
 
     this.input.toggleAttribute("suppress-focus-border", true);
     this.input.setAttribute("open", "true");
diff --git a/browser/themes/shared/urlbar-searchbar.css b/browser/themes/shared/urlbar-searchbar.css
index e406f8d26d2c..554cf7b2f3af 100644
--- a/browser/themes/shared/urlbar-searchbar.css
+++ b/browser/themes/shared/urlbar-searchbar.css
@@ -427,6 +427,19 @@
   transform: scaleX(-1);
 }
 
+.urlbar-history-dropmarker {
+  list-style-image: url(chrome://global/skin/icons/arrow-dropdown-16.svg);
+  transition: opacity 0.15s ease;
+}
+
+#urlbar[switchingtabs] > #urlbar-input-container > .urlbar-history-dropmarker {
+  transition: none;
+}
+
+#nav-bar:not([customizing="true"]) > #nav-bar-customization-target > #urlbar-container:not(:hover) > #urlbar:not([focused]) > #urlbar-input-container > .urlbar-history-dropmarker {
+  opacity: 0;
+}
+
 #pageActionButton,
 .share-more-button {
   list-style-image: url("chrome://global/skin/icons/more.svg");
@@ -546,6 +559,17 @@
   mask-position-x: 0;
 }
 
+/* Translate the dropmarker to give illusion of increasing width of the recommendation  */
+#urlbar[cfr-recommendation-state] .urlbar-history-dropmarker {
+  transition: transform ease-in-out var(--cfr-animation-duration);
+}
+#urlbar[cfr-recommendation-state="expanded"] .urlbar-history-dropmarker {
+  transform: translateX(calc(var(--cfr-label-width) * -1));
+}
+#urlbar[cfr-recommendation-state="expanded"] .urlbar-history-dropmarker:-moz-locale-dir(rtl) {
+  transform: translateX(calc(var(--cfr-label-width)));
+}
+
 /* Shift the url-bar text fading to stop the recommendation overlapping */
 #urlbar[cfr-recommendation-state] #urlbar-input {
   /* A mask-image is usually only defined for the url bar when text overflows.
-- 
2.38.0

